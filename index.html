<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PRENOTAZIONE sportelli TIC con ALESSANDRO ZANZOt Webex</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.4; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f0f0f0; }
  .busy { color: #666; font-size: 0.95em; }
  a { word-break: break-all; }
  button { padding: 6px 10px; cursor: pointer; }
  button[disabled] { opacity: .6; cursor: not-allowed; }

  .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
           align-items: center; justify-content: center; padding: 12px; }
  .modal-content { background: #fff; padding: 18px; max-width: 440px; width: 100%; border-radius: 8px; }
  label { display: block; margin-top: 12px; text-align: left; }
  input, select { width: 100%; padding: 8px; margin-top: 6px; box-sizing: border-box; }
  .actions { margin-top: 14px; display: flex; gap: 10px; justify-content: flex-end; }
  .status { margin-top: 10px; font-size: 14px; }
  .error { color: #b00020; }
  .ok { color: #0a7a0a; }
</style>
</head>

<body>
<h2>Prenotazione slot Webex</h2>
<p> È possibile prenotare uno slot "libero" entro 24 ore prima dell'effettivo appuntamento.</p>

<table id="slots">
  <thead>
    <tr>
      <th>Data</th>
      <th>Ora</th>
      <th>Stato</th>
      <th>Azione</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- MODALE PRENOTAZIONE -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Prenota slot</h3>
    <div id="slotInfo" style="font-size:14px;margin-bottom:6px;"></div>

    <label>Nome e cognome
      <input id="fullName" placeholder="Es. Mario Rossi">
    </label>

    <label>Email
      <input id="email" type="email" placeholder="nome.cognome@esempio.it">
    </label>

    <label>Gruppo
      <select id="group">
        <option>K primo grado</option>
        <option>L primo grado</option>
        <option>D secondo grado</option>
      </select>
    </label>

    <div class="actions">
      <button id="cancelBtn" type="button">Annulla</button>
      <button id="confirmBtn" type="button">Conferma</button>
    </div>

    <div class="status" id="modalStatus"></div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbz_IvjAGirhFh89_1bvnU267cGdMSPyObvKL8Hm3lh0l6kdCITRHXUzRznnjgoNv95GdA/exec";

let selectedRow = null;

const tbody = document.querySelector("#slots tbody");
const modal = document.getElementById("modal");
const slotInfo = document.getElementById("slotInfo");
const modalStatus = document.getElementById("modalStatus");
const fullNameInput = document.getElementById("fullName");
const emailInput = document.getElementById("email");
const groupSelect = document.getElementById("group");
const confirmBtn = document.getElementById("confirmBtn");
const cancelBtn = document.getElementById("cancelBtn");

function escapeHtml(s) {
  return (s || "")
    .toString()
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

// Trasforma qualunque valore gruppo in K/L/D (robusto anche se dal backend arriva "K PRIMO GRADO", ecc.)
function groupLetter(groupValue) {
  const g = (groupValue || "").toString().trim().toUpperCase();
  if (g.startsWith("K")) return "K";
  if (g.startsWith("L")) return "L";
  if (g.startsWith("D")) return "D";
  return ""; // se non c'è, non mostra nulla
}

function webexLinkCell(webexUrl) {
  const url = (webexUrl || "").toString().trim();
  if (!url) return "—";
  const safe = escapeHtml(url);
  return `<a href="${safe}" target="_blank" rel="noopener noreferrer"> Vai alla stanza Webex per lo sportello</a>`;
}

function loadSlots() {
  fetch(API + "?action=list")
    .then(r => r.json())
    .then(data => {
      tbody.innerHTML = "";
      (data.slots || []).forEach(s => {
        const statusUp = (s.status || "").toString().trim().toUpperCase();
        const isBusy = statusUp === "OCCUPATO";

        const gLetter = groupLetter(s.group); // <-- usa il gruppo dal backend

        // Colonna Stato: Occupato – K/L/D
        const statusText = isBusy
          ? `Occupato${gLetter ? " – " + gLetter : ""}`
          : "Libero";

        // Colonna Azione: se occupato mostra Webex, se libero mostra Prenota
        const actionHtml = isBusy
          ? webexLinkCell(s.webex)
          : `<button type="button" data-row="${s.row}" data-label="${escapeHtml(s.date)} ${escapeHtml(s.time)}">Prenota</button>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(s.date)}</td>
          <td>${escapeHtml(s.time)}</td>
          <td class="${isBusy ? "busy" : ""}">${statusText}</td>
          <td>${actionHtml}</td>
        `;
        tbody.appendChild(tr);
      });

      // collega i bottoni
      tbody.querySelectorAll("button[data-row]").forEach(btn => {
        btn.addEventListener("click", () => {
          openModal(parseInt(btn.dataset.row, 10), btn.dataset.label);
        });
      });
    });
}

function openModal(row, label) {
  selectedRow = row;
  slotInfo.textContent = "Stai prenotando: " + label;
  modalStatus.textContent = "";
  modalStatus.className = "status";
  modal.style.display = "flex";
  fullNameInput.value = "";
  emailInput.value = "";
  groupSelect.selectedIndex = 0;
  fullNameInput.focus();
}

function closeModal() {
  modal.style.display = "none";
  selectedRow = null;
  confirmBtn.disabled = false;
  confirmBtn.textContent = "Conferma";
}

function confirmBooking() {
  const fullName = fullNameInput.value.trim();
  const email = emailInput.value.trim();
  const group = groupSelect.value;

  if (!fullName) {
    modalStatus.textContent = "Inserisci nome e cognome";
    modalStatus.className = "status error";
    return;
  }
  if (!email) {
    modalStatus.textContent = "Inserisci una email valida";
    modalStatus.className = "status error";
    return;
  }

  confirmBtn.disabled = true;
  confirmBtn.textContent = "Invio…";
  modalStatus.textContent = "";

  // NB: niente header application/json -> evita preflight/CORS con Apps Script
  fetch(API, {
    method: "POST",
    body: JSON.stringify({ row: selectedRow, fullName, email, group })
  })
  .then(r => r.json())
  .then(res => {
    if (res.ok) {
      modalStatus.textContent = "Prenotazione confermata.";
      modalStatus.className = "status ok";
      setTimeout(() => { closeModal(); loadSlots(); }, 450);
    } else {
      modalStatus.textContent = res.error || "Errore";
      modalStatus.className = "status error";
      confirmBtn.disabled = false;
      confirmBtn.textContent = "Conferma";
    }
  })
  .catch(() => {
    modalStatus.textContent = "Errore di rete";
    modalStatus.className = "status error";
    confirmBtn.disabled = false;
    confirmBtn.textContent = "Conferma";
  });
}

cancelBtn.addEventListener("click", closeModal);
confirmBtn.addEventListener("click", confirmBooking);
modal.addEventListener("click", e => { if (e.target === modal) closeModal(); });

loadSlots();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Prenotazione slot Webex</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f0f0f0; }
  button { padding: 6px 10px; cursor: pointer; }
  .busy { color: #999; }
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
  }
  .modal-content {
    background: #fff;
    max-width: 400px;
    margin: 10% auto;
    padding: 20px;
  }
  label { display: block; margin-top: 10px; }
  input, select, textarea {
    width: 100%;
    padding: 6px;
    margin-top: 4px;
  }
</style>
</head>

<body>

<h2>Prenotazione slot Webex</h2>

<table id="slots">
  <thead>
    <tr>
      <th>Data</th>
      <th>Ora</th>
      <th>Stato</th>
      <th>Azione</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Prenota slot</h3>

    <label>Nome e cognome
      <input id="fullName" required>
    </label>

    <label>Gruppo
      <select id="group">
        <option>Di secondo grado</option>
        <option>K Savigliano primo grado</option>
        <option>Lx Savigliano primo grado</option>
      </select>
    </label>

    <label>Sottogruppo / colleghi
      <textarea id="subgroup"></textarea>
    </label>

    <br>
    <button onclick="confirmBooking()">Conferma</button>
    <button onclick="closeModal()">Annulla</button>
  </div>
</div>

<script>
const API =
  "https://script.google.com/macros/s/AKfycbz_IvjAGirhFh89_1bvnU267cGdMSPyObvKL8Hm3lh0l6kdCITRHXUzRznnjgoNv95GdA/exec";

let selectedRow = null;

function loadSlots() {
  fetch(API + "?action=list")
    .then(r => r.json())
    .then(data => {
      const tbody = document.querySelector("#slots tbody");
      tbody.innerHTML = "";
      data.slots.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.date}</td>
          <td>${s.time}</td>
          <td class="${s.status === 'OCCUPATO' ? 'busy' : ''}">
            ${s.status}
          </td>
          <td>
            ${s.status === 'LIBERO'
              ? `<button onclick="openModal(${s.row})">Prenota</button>`
              : "â€”"}
          </td>`;
        tbody.appendChild(tr);
      });
    });
}

function openModal(row) {
  selectedRow = row;
  document.getElementById("modal").style.display = "block";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

<script>
function confirmBooking() {
  const fullName = document.getElementById("fullName").value.trim();
  const group = document.getElementById("group").value;
  const subgroup = document.getElementById("subgroup").value.trim();

  if (!fullName) {
    alert("Inserisci nome e cognome");
    return;
  }

  const payload = {
    row: selectedRow,
    fullName,
    group,
    subgroup
  };

  // IMPORTANTE: niente headers application/json -> evita preflight CORS
  fetch(API, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(res => {
    if (res.ok) {
      alert("Prenotazione confermata");
      closeModal();
      document.getElementById("fullName").value = "";
      document.getElementById("subgroup").value = "";
      loadSlots();
    } else {
      alert(res.error || "Errore nella prenotazione");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Errore di rete/CORS. Apri Console (F12) per dettagli.");
  });
}
</script>

loadSlots();
</script>

</body>
</html>

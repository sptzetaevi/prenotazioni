<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Prenotazione slot Webex</title>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    line-height: 1.4;
  }
  h2 { margin-top: 0; }

  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }
  th { background: #f0f0f0; }

  .busy {
    color: #666;
    font-size: 0.95em;
  }

  button {
    padding: 6px 10px;
    cursor: pointer;
  }

  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background: #fff;
    padding: 20px;
    max-width: 420px;
    width: 100%;
    border-radius: 8px;
  }

  label {
    display: block;
    margin-top: 12px;
    text-align: left;
  }
  input {
    width: 100%;
    padding: 8px;
    margin-top: 6px;
    box-sizing: border-box;
  }

  .actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  .status {
    margin-top: 10px;
    font-size: 14px;
  }
  .error { color: #b00020; }
  .ok { color: #0a7a0a; }
</style>
</head>

<body>

<h2>Prenotazione slot Webex</h2>
<p>Gli slot entro 24 ore vengono automaticamente bloccati.</p>

<table id="slots">
  <thead>
    <tr>
      <th>Data</th>
      <th>Ora</th>
      <th>Stato</th>
      <th>Azione</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- MODALE -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Prenota slot</h3>
    <div id="slotInfo" style="font-size:14px; margin-bottom:8px;"></div>

    <label>Nome e cognome
      <input id="fullName" placeholder="Es. Mario Rossi">
    </label>

    <div class="actions">
      <button id="cancelBtn">Annulla</button>
      <button id="confirmBtn">Conferma</button>
    </div>

    <div class="status" id="modalStatus"></div>
  </div>
</div>

<script>
const API =
  "https://script.google.com/macros/s/AKfycbz_IvjAGirhFh89_1bvnU267cGdMSPyObvKL8Hm3lh0l6kdCITRHXUzRznnjgoNv95GdA/exec";

let selectedRow = null;

const tbody = document.querySelector("#slots tbody");
const modal = document.getElementById("modal");
const slotInfo = document.getElementById("slotInfo");
const modalStatus = document.getElementById("modalStatus");
const fullNameInput = document.getElementById("fullName");
const confirmBtn = document.getElementById("confirmBtn");
const cancelBtn = document.getElementById("cancelBtn");

function escapeHtml(s) {
  return (s || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function loadSlots() {
  fetch(API + "?action=list")
    .then(r => r.json())
    .then(data => {
      tbody.innerHTML = "";

      data.slots.forEach(s => {
        const tr = document.createElement("tr");
        const isBusy = s.status === "OCCUPATO";

        tr.innerHTML = `
          <td>${escapeHtml(s.date)}</td>
          <td>${escapeHtml(s.time)}</td>
          <td class="busy">
            ${
              isBusy
                ? `Occupato${s.name ? " – " + escapeHtml(s.name) : ""}`
                : "Libero"
            }
          </td>
          <td>
            ${
              isBusy
                ? "—"
                : `<button onclick="openModal(${s.row}, '${escapeHtml(s.date)} ${escapeHtml(s.time)}')">Prenota</button>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });
    });
}

function openModal(row, label) {
  selectedRow = row;
  slotInfo.textContent = "Stai prenotando: " + label;
  modalStatus.textContent = "";
  modal.style.display = "flex";
  fullNameInput.value = "";
  fullNameInput.focus();
}

function closeModal() {
  modal.style.display = "none";
  selectedRow = null;
  confirmBtn.disabled = false;
  confirmBtn.textContent = "Conferma";
}

function confirmBooking() {
  const fullName = fullNameInput.value.trim();
  if (!fullName) {
    modalStatus.textContent = "Inserisci nome e cognome";
    modalStatus.className = "status error";
    return;
  }

  confirmBtn.disabled = true;
  confirmBtn.textContent = "Invio…";
  modalStatus.textContent = "";

  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      row: selectedRow,
      fullName: fullName
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.ok) {
      modalStatus.textContent = "Prenotazione confermata";
      modalStatus.className = "status ok";
      setTimeout(() => {
        closeModal();
        loadSlots();
      }, 400);
    } else {
      modalStatus.textContent = res.error || "Errore";
      modalStatus.className = "status error";
      confirmBtn.disabled = false;
      confirmBtn.textContent = "Conferma";
    }
  })
  .catch(() => {
    modalStatus.textContent = "Errore di rete";
    modalStatus.className = "status error";
    confirmBtn.disabled = false;
    confirmBtn.textContent = "Conferma";
  });
}

cancelBtn.addEventListener("click", closeModal);
confirmBtn.addEventListener("click", confirmBooking);
modal.addEventListener("click", e => {
  if (e.target === modal) closeModal();
});

loadSlots();
</script>

</body>
</html>
